Disk encryption
===============

In order to mount encrypted disk, Sabakan provides `sabakan-cryptsetup` as follows.

* Sabakan keeps encryption keys of all disks which are specified by `sabakan-cryptsetup` argument.

    Each node generates a pair of 512 bit random keys. One is for [cryptsetup][], and another is to encrypt 
    the other by [one-time pad][]. The node keeps this latter key in the first sector of the metadata partition.

    The encrypted key is stored `sabakan`. Hence, the node cannot the server cannot decrypt its own 
    own storage data without `sabakan`, and vice versa.

    If encryption key of a disk is not registered on `sabakan`, the disk will be re-encrypted by a new `one-time pad` and a `key`.
    `sabakan-cryptsetup` requests `/api/v1/crypts` to manage keys. See details [API](api.md).

* Operators need to setup RAID, filesystem format, and disk mount after decrypt disks.

    Operators could prepare own scripts or systemd units to mount disks.
    
## Crypt specs

`sabakan-cryptsetup` uses [cryptsetup][] in plain mode, therefore, it is mostly raw dm-crypt.

| Parameter    | Value
| ---------    | -----
| Cipher       | AES
| Chain Mode   | XTS
| IV generator | plain64
| Key bits     | 512 (256 for AES, 256 for XTS)

`sabakan-cryptsetup` writes/reads from the disk as metadata. Space for metadata keeps `2 MiB` by `--offset` option of the `cryptsetup`.

| Name           | Size(byte) | Description
| ----           | ---------- | -----------
| `magic`        | 8          | A magic number to detect if disk is encrypted by `sabakan-crypsetup`.
| `one-time pad` | 64         | An one-time pad as a pair of XOR. It is generated by `crypto/rand` of Go.
| `ID`           | 16         | An unique identifier like an UUID to detect if key is registered on the `sabakan`. It is generated by `crypto/rand` of Go.

## Procedure of the disk encryption and decryption

1. `sabakan-cryptsetup` detect storage devices on the `/dev/disk/by-path` using a glob which is specified as an argument.
2. Read `one-time pad` and `ID`, and send HTTP request to `sabakan` whether a `key` and `ID` of its disk are registered. If not, `sabakan-cryptsetup` re-ecnrypts the disk.
    1. Generate `one-time pad`, `key` and `ID`.
    2. Write `magic`, `one-time pad` and `ID` to metadata partition.
    3. Register XOR between `one-time pad` and `key` to `sabakan` with `ID`.`
3. Execute `cryptsetup` to create `/dev/mapper/crypt-REALPATH-ID` of each disk. `REALPATH` is something like `sda`, `vda`.
4. Setup md device or initialize filesystem.
5. Mount filesystem.
6. Ready for apps!

To deploy above procedure to nodes, Operator needs to prepare systemd unit files by Ignition. For example,

- `sabakan-cryptsetup.service` ... An oneshot service that executes `sabakan-cryptsetup` to create a device mapper.
- `var-setup.service` ... Create a filesystem.
- `var.mount` ... Mount a device mapper.

[dm-crypt]: https://gitlab.com/cryptsetup/cryptsetup/wikis/DMCrypt
[one-time pad]: https://en.wikipedia.org/wiki/One-time_pad
[cryptsetup]: https://gitlab.com/cryptsetup/cryptsetup/wikis/home
